<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name=viewport content="width=device-width,height=device-height,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1">
    <title>远程遥控</title>
    <script>
        (function () {
            function o() {
                document.documentElement.style.fontSize = parseInt((document.documentElement.clientWidth > 414 ?
                    414 : document.documentElement.clientWidth) * 13 / 375) + "px"
            }
            var e = null;
            window.addEventListener("resize", function () {
                clearTimeout(e), e = setTimeout(o, 100)
            }, !1), o()
        })(window);
    </script>
    <link rel="stylesheet" href="font/iconfont.css">
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/style.css">
    <style type="text/css">
        .main footer button {
            line-height: 3rem;
            font-size: 1.3rem;
        }

        .main footer button.active {
            background: #27C06D;
        }
    </style>

</head>

<body style="display:none;">
    <div id="controls" class="main flex column h100vh">
        <header>
            <div class="outerdiv">
                <div class="innerdiv">
                    <div class="circle"></div>
                    <div class="maintxt tcenter flex acenter jcenter">
                        <div>
                            <div>风量</div>
                            <div class="big20">{{windNum}}</div>
                            <div>m³/h</div>
                        </div>
                    </div>
                </div>
                <i class="iconfont icon-wifi"></i>
            </div>
            <div class="stateonoff flex">
                <div class="flex_1 flex acenter jcenter item">
                    <label>滤芯容量：</label>
                    <span class="flex_1 progress orange">
                        <i>60%</i>
                    </span>
                    <i class="iconfont icon-icon"></i>
                </div>
                <div class="flex_1 flex acenter jcenter item">
                    <label>滤芯效率：</label>
                    <span class="flex_1 progress red">
                        <i>低</i>
                    </span>
                </div>
            </div>
        </header>
        <section class="controlpage flex_1 scroll">
            <dl>
                <dd class="flex acenter">
                    <label class="flex_1">辅热模式</label>
                    <label class="tcenter flex_1">
                        <input type="radio" v-model="heatingModel" value="1">
                        <span class="icons close-smart" @click="toggel('heating_auto')"></span>
                        <span>智能模式</span>
                    </label>
                    <label class="tcenter flex_1">
                        <input type="radio" v-model="heatingModel" value="2">
                        <span class="icons open" @click="toggel('heating_on')"></span>
                        <span>常开</span>
                    </label>
                    <label class="tcenter flex_1">
                        <input type="radio" v-model="heatingModel" value="3">
                        <span class="icons close" @click="toggel('heating_off')"></span>
                        <span>常关</span>
                    </label>
                </dd>
                <dd class="flex acenter jcenter">
                    <label class="flex_1">风机模式</label>
                    <label class="tcenter flex_1">
                        <input type="radio" v-model="windModel" value="1">
                        <span class="icons open-smart" @click="toggel('wind_auto')"></span>
                        <span>智能模式</span>
                    </label>
                    <label class="tcenter flex_1">
                        <input type="radio" v-model="windModel" value="2">
                        <span class="icons handle" @click="toggel('wind_manual')"></span>
                        <span>手动模式</span>
                    </label>
                    <label class="tcenter flex_1">
                        <input type="radio" v-model="windModel" value="3">
                        <span class="icons sleep" @click="toggel('sleep')"></span>
                        <span>睡眠模式</span>
                    </label>
                </dd>
            </dl>
        </section>
        <footer class="flex">
            <button type="button" class="flex_1" :class="{'active': powerOn}" @click="powerManager">
                <i class="iconfont icon-guanji"></i> {{ !powerOn ? "开机" : "关机"}}</button>
            <button type="button">
                <i class="iconfont icon-dingshi"></i> 定时关机</button>
        </footer>
    </div>
    <script src="https://img.hcharts.cn/jquery/jquery-1.8.3.min.js"></script>
    <script src="js/vue.min.js"></script>
    <script src="js/socket.io.js"></script>
    <script>
        var socket;
        function initPage(deviceId) {
            var Ctrl = new Vue({
                el: '#controls',
                data: {
                    windNum: '-',
                    heatingModel: 1,
                    windModel: 1,
                    powerOn: false
                },
                mounted() {
                    document.getElementsByTagName('body')[0].style.display = 'block';
                },
                methods: {
                    toggel: function (key) {
                        msgToSer(deviceId, key);
                    },
                    powerManager: function () {
                        msgToSer(deviceId, 'power');
                    }
                }
            });
            socket = io.connect('http://www.windme.cn:3000/')
            socket.on('connect', function () {
                log('连接成功：' + socket.id);
                msgToSer(deviceId, 'refresh');
            });
            //接收消息
            socket.on('clientMsg', function (data) {
                console.log('clientMsg', data);
                if (null == data) {
                    return;
                }
                // 赋值方法
                Ctrl.windNum = data.windNum;
                Ctrl.heatingModel = data.heatingModel;
                Ctrl.windModel = data.windModel;
                Ctrl.powerOn = data.powerOn == 'true' ? true : false;
            });
            //断开连接（系统方法disconnct不可更改为其它）
            socket.on('disconnect', function () {
                log('连接断开!');
            });
            //重新连接
            socket.on('reconnect', function () {
                log('重新连接...');
            });
            //连接失败
            socket.on('reconnect_error', function () {
                log('连接失败!');
            });
        }
    </script>
    <script>
        var deviceId = getParam('deviceId');
        function getParam(name, href) {
            name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
            var regexS = "[\\?&]" + name + "=([^&#]*)";
            var regex = new RegExp(regexS);
            var results = regex.exec(href || window.location.href);
            return results ? results[1] : "";
        }
        initPage(deviceId);
    </script>
    <script>
        function msgToSer(deviceId, command) {
            var jsonObject = {
                pageName: 'control',
                deviceId: deviceId,
                command: command
            };
            socket.emit('order', jsonObject)
        }

        function log(message) {
            console.log('message', message);
        }
    </script>
</body>

</html>